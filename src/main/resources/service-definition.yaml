kind: Connection
metadata:
  name: mysqlConn
  kind: mysql
spec:
  username: root
  password: password
  db: mysql
  host: "host.minikube.internal"
  port: 3306

---

kind: APIs
metadata:
  prefix: ""
spec:
  - path: "/"
    response:
      status: 200
      headers:
        from: svc1
      data: 'Success'
      statusText: 'OK'

  - path: "/api"
    dependents:
      - path: "localhost:8080/"
      - path: "localhost:8080/"
    scripts:
      onRequest: |-
        let dependents = apiSpec.dependents;
        dependents.forEach((dep)=>{
          if(!dep.path.includes('chakko'))
            dep.path=dep.path+"?q=chakko"
        });
      onResponse: |-
        function getData(dep) {
          return dep.response.data+'1';
        }
        apiSpec.dependents.forEach(dep=>dep.response.data+=getData(dep));
    response:
      status: 200
      headers:
        from: svc1
      json: |
        {
          "response1": "${apiSpec.dependents[0].response.data}",
          "response2": "${apiSpec.dependents[1].response.data}"
        }

  - path: "/times"
    dependents:
      - path: "localhost:8080/time"
      - path: "localhost:8080/time"
      - path: "localhost:8080/dbtime"
    response:
      status: 200
      headers:
        from: svc1
      json: |
        {
          "service1_time": "${new Date()}",
          "service2_time": "${apiSpec.dependents[0].response.json.time}",
          "service3_time": "${apiSpec.dependents[1].response.json.time}",
          "DB_time": "${apiSpec.dependents[2].response.json.time}"
        }

  - path: "/mysql"
    dependents:
      - kind: Connection
        name: mysqlConn
        query: "SELECT CURDATE();"
      - path: "localhost:8080/"
    response:
      status: 200
      headers:
        from: svc1
      json: |
        {
          "time": "${apiSpec.dependents[0].response[0]['CURDATE()']}",
          "svc3_res": "${apiSpec.dependents[1].response.data}"
        }

  - path: "/failpointpath"
    dependents:
      - path: "localhost:8080/failpoint"
    response:
      status: 200
      headers:
        from: svc1
      json: |
        {
          "time": "${new Date()}",
          "failpoint": "ignored"
        }

  - path: "/failpoint"
    dependents:
      - kind: Connection
        name: mysqlConn_missing
        query: "SELECT CURDATE();"
    response:
      status: 200
      headers:
        from: svc2
      json: |
        {
          "time": "${new Date()}"
        }